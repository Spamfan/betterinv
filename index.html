<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spamfan's inventory optimizer (alpha v21)</title>
    
    <!-- PDF.js and jsPDF library CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        #app-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        h1 {
            color: #1c1e21;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        
        #version-span {
            font-weight: normal;
            cursor: pointer;
            user-select: none;
        }

        #upload-area {
            border: 2px dashed #dddfe2;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        
        #upload-area.dragover {
            border-color: #1877f2;
            background-color: #f0f8ff;
        }
        
        #upload-area p { margin: 0; font-weight: 600; color: #606770; }
        #upload-input { display: none; }

        .status-section {
            display: none;
            padding: 10px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: left;
        }
        
        .status-text { font-weight: 600; }
        .status-filename { font-weight: normal; font-style: italic; color: #606770; margin-left: 8px; }
        
        .control-section { text-align: left; margin-bottom: 15px; }
        .control-section label { display: block; margin-bottom: 8px; font-weight: 600; color: #606770; }
        
        .toggles-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 20px;
        }
        .toggle-option { display: flex; align-items: center; }
        .toggle-option label { margin: 0 0 0 8px; font-weight: normal; }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #highlight-btn, #process-btn, #copy-log-btn {
            flex-grow: 1;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #highlight-btn, #copy-log-btn { background-color: #e4e6eb; color: #050505; }
        #process-btn { background-color: #1877f2; color: white; }
        
        #comments {
            width: 100%;
            padding: 10px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            box-sizing: border-box;
            resize: vertical;
            min-height: 60px;
        }
        
        #konami-message {
            display: none;
            text-align: center;
            font-style: italic;
            color: #606770;
            margin-top: 5px;
        }

        #how-to-use-container {
            text-align: left;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #e4e6eb;
        }

        #how-to-use-container h3, #how-to-use-container h4 { margin: 15px 0 10px 0; color: #606770; font-size: 1em; }
        #how-to-use-container ol, #how-to-use-container ul { padding-left: 20px; margin: 0; font-size: 0.9em; color: #606770; line-height: 1.6; }
        #how-to-use-container ul { margin-top: 5px; }
        .inline-svg { width: 1em; height: 1em; vertical-align: middle; margin: 0 2px; }

        #dev-console-container {
            display: none;
            text-align: left;
            margin-top: 20px;
        }
        #dev-console-output {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        /* Modal Styles */
        .modal-container { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); width: 80%; max-width: 600px; max-height: 90%; display: flex; flex-direction: column; }
        .modal-header { padding: 10px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.2em; }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        #dev-mode-text { text-align: center; padding: 40px 20px; }
        #dev-mode-text p { margin: 5px 0; }
        .emphasis-header { display: flex; align-items: center; font-weight: bold; font-size: 0.8em; color: #606770; background-color: #f0f2f5; padding: 10px 20px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 10; }
        .emphasis-header-hide, .emphasis-header-partial, .emphasis-header-full { min-width: 40px; text-align: center; }
        .emphasis-header-text { flex-grow: 1; padding-left: 5px; }
        .modal-body { flex-grow: 1; padding: 0; overflow-y: auto; }
        #emphasis-list-container { padding: 5px 20px; }
        #pdf-preview-iframe { width: 100%; height: 100%; border: none; }
        .emphasis-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #e9ebee; }
        .emphasis-item-hide { min-width: 40px; text-align: center; }
        .emphasis-item .hide-icon { width: 18px; height: 18px; cursor: pointer; fill: #606770; }
        .emphasis-item.item-hidden .hide-icon { fill: #ccc; }
        .emphasis-item input[type="checkbox"] { min-width: 40px; height: 18px; margin: 0; }
        .emphasis-item-text { font-size: 0.9em; padding-left: 5px; transition: color 0.2s; }
        .emphasis-item.item-hidden .emphasis-item-text { color: #ccc; text-decoration: line-through; }
        .emphasis-list-carrier-header { font-weight: bold; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 2px solid #050505; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; }
        #download-btn { display: none; }
        .modal-footer button { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="app-container">
        <h1>Spamfan's inventory optimizer <span id="version-span"></span></h1>
        
        <div id="upload-area">
            <input type="file" id="upload-input" multiple accept=".pdf">
            <p>Drag & drop files here.</p>
        </div>

        <div id="status-container">
            <div class="status-section" id="att-status"><div><span class="status-text">AT&T:</span><span class="status-filename"></span></div></div>
            <div class="status-section" id="vzw-status"><div><span class="status-text">Verizon:</span><span class="status-filename"></span></div></div>
            <div class="status-section" id="tmo-status"><div><span class="status-text">T-Mobile:</span><span class="status-filename"></span></div></div>
        </div>

        <div class="toggles-wrapper">
            <div class="toggle-option">
                <input type="checkbox" id="isolate-iphones">
                <label for="isolate-iphones">Isolate iPhones</label>
            </div>
            <div class="toggle-option">
                <input type="checkbox" id="dev-console-toggle">
                <label for="dev-console-toggle">Use Developer Settings</label>
            </div>
        </div>
        
        <div class="action-buttons">
            <button id="highlight-btn">Customize</button>
            <button id="process-btn">Preview or Print</button>
        </div>

        <div class="control-section">
            <label for="comments">Comments (optional)</label>
            <textarea id="comments"></textarea>
            <p id="konami-message">Also try Tank Tycoon!</p>
        </div>

        <div id="how-to-use-container"></div>

        <div id="dev-console-container">
            <pre id="dev-console-output"></pre>
            <button id="copy-log-btn">Copy Log</button>
        </div>
    </div>

    <!-- Modals are empty here, populated by script -->
    <div id="preview-modal" class="modal-container"></div>
    <div id="emphasis-modal" class="modal-container"></div>
    <div id="dev-mode-modal" class="modal-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SCRIPT INITIALIZATION ---
        const APP_VERSION = '(Alpha v21)';
        document.getElementById('version-span').textContent = APP_VERSION;
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;
        const HIDE_ICON_SVG = `<svg class="hide-icon inline-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11.83,9.53c1.53,0.24,2.74,1.46,2.98,2.98L11.83,9.53z M12,6c3.79,0,7.17,2.13,8.82,5.5c-0.64,1.32-1.57,2.44-2.68,3.32l1.42,1.42c1.51-1.26,2.7-2.89,3.43-4.74C21.27,7.11,17,4,12,4c-1.4,0-2.73,0.25-3.98,0.7L9.63,6.3C10.4,6.12,11.19,6,12,6z M2,4.27l3.11,3.11C3.26,8.9,2.42,10.36,2.03,11.5C3.73,15.89,7.5,18,12,18c1.55,0,3.03-0.3,4.38-0.84l2.1,2.1L20,18.73L3.27,2L2,4.27z M7.53,9.8l1.55,1.55C9.03,11.49,9,11.74,9,12c0,1.66,1.34,3,3,3c0.26,0,0.51-0.03,0.75-0.08l1.55,1.55C13.96,15.86,13,16,12,16c-2.76,0-5-2.24-5-5C7,10.54,7.14,9.96,7.53,9.8z"/></svg>`;
        const MORE_OPTIONS_SVG = `<svg class="inline-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#606770"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
        document.getElementById('how-to-use-container').innerHTML = `
            <h3><strong>Heads up! This software is still in development and can make mistakes.</strong></h3>
            <h4><strong>HOW TO USE</strong></h4>
            <ol>
                <li><strong>Save Each Carrier's Inventory as a PDF</strong>
                    <ul>
                        <li>CRITICAL: You must open WARP in a new, separate window (Ctrl + N). The optimizer will not accept file inputs if WARP is only in a separate tab.</li>
                        <li>In the new WARP window, navigate to: Manage Inventory > View current inventory.</li>
                        <li>Select AT&T > check the box that says "In Stock," then click the More Options (${MORE_OPTIONS_SVG}) menu, and choose Print.</li>
                        <li>Change the "Destination" printer from "CKPR1" to "Save as PDF."
                            <ul><li>Note: For best results, use the original formatting (100% scale and default margins), as this has passed user testing.</li></ul>
                        </li>
                        <li>Name the file exactly "ATT.pdf". If a file with that name already exists, you overwrite it.</li>
                        <li>Repeat this exact process for Verizon, naming the file "VZW.pdf".</li>
                        <li>Repeat one last time for T-Mobile, naming the file "TMO.pdf".</li>
                        <li>To get the File Explorer ready for the next step, start to save the "TMO.pdf" file a second time, following steps all the way past the part where you label it as "TMO.pdf," but this time don't actually finish saving it. Just leave the File Explorer window open.</li>
                    </ul>
                </li>
                <li><strong>Drag and Drop Files into the Optimizer</strong>
                    <ul>
                        <li>With the File Explorer window still open from the last step, locate the three PDF files you just created (ATT.pdf, VZW.pdf, TMO.pdf).</li>
                        <li>Individually, click and hold each file and drag it directly into the optimizer window.
                            <ul><li>Tip: While holding the file, you can use Alt + Tab or hover above the Chrome icon in your taskbar to switch from the File Explorer to the optimizer window to drop the file.</li></ul>
                        </li>
                    </ul>
                </li>
                <li><strong>Optional: Customize Your List</strong>
                    <ul>
                        <li>Partial Highlight (left checkbox): Highlights only the phone's name. (Recommended for good deals).</li>
                        <li>Full Highlight (right checkbox): Highlights the entire row for that device. (Recommended for extra good deals).</li>
                        <li>Hide (${HIDE_ICON_SVG} toggle): Use this to hide unwanted listings, such as demo-only or unlocked devices.</li>
                        <li>Master Checkboxes: Use the main checkboxes at the top of the list to toggle partial or full highlights for the entire window at once.</li>
                        <li>Click Done to save your customizations. Your highlight preferences are saved within the app, so you can adjust them anytime.</li>
                    </ul>
                </li>
                <li><strong>Print the Combined PDF</strong>
                    <ul>
                        <li>Click the blue "Preview or Print" button.</li>
                        <li>A preview pane showing the combined PDF will appear. Right-click anywhere on the PDF preview and choose Print.</li>
                        <li>Important: Be sure to re-select your store's printer (e.g., "CKPR1") as the destination so you print the combined file instead of saving it as a PDF again.</li>
                    </ul>
                </li>
            </ol>
        `;

        // --- GLOBAL STATE ---
        let appState = { att: { consolidatedList: [], emphasis: new Map() }, vzw: { consolidatedList: [], emphasis: new Map() }, tmo: { consolidatedList: [], emphasis: new Map() } };
        let devModalCloseable = { button: true, backdrop: true };

        // --- LOCALSTORAGE FUNCTIONS ---
        const saveSettings = () => { /* identical to v20 */ try { const cleanEmphasis = (emphasisMap) => { const cleanEntries = Array.from(emphasisMap.entries()).map(([key, value]) => { const { partial, full } = value; return [key, { partial, full }]; }); return new Map(cleanEntries); }; const settings = { isolate: isolateIphonesCheckbox.checked, emphasis: { att: Array.from(cleanEmphasis(appState.att.emphasis).entries()), vzw: Array.from(cleanEmphasis(appState.vzw.emphasis).entries()), tmo: Array.from(cleanEmphasis(appState.tmo.emphasis).entries()) } }; localStorage.setItem('betterInvSettings', JSON.stringify(settings)); } catch (error) { console.error("Could not save settings:", error); } };
        const loadSettings = () => { /* identical to v18 */ try { const savedSettings = localStorage.getItem('betterInvSettings'); if (savedSettings) { const settings = JSON.parse(savedSettings); isolateIphonesCheckbox.checked = settings.isolate || false; appState.att.emphasis = new Map(settings.emphasis.att || []); appState.vzw.emphasis = new Map(settings.emphasis.vzw || []); appState.tmo.emphasis = new Map(settings.emphasis.tmo || []); } } catch (error) { console.error("Could not load settings, using defaults:", error); } };

        // --- STATIC UI ELEMENT SELECTORS ---
        const versionSpan = document.getElementById('version-span');
        const uploadArea = document.getElementById('upload-area');
        const uploadInput = document.getElementById('upload-input');
        const isolateIphonesCheckbox = document.getElementById('isolate-iphones');
        const highlightBtn = document.getElementById('highlight-btn');
        const processBtn = document.getElementById('process-btn');
        const commentsInput = document.getElementById('comments');
        const konamiMessage = document.getElementById('konami-message');
        const devConsoleToggle = document.getElementById('dev-console-toggle');
        const devConsoleContainer = document.getElementById('dev-console-container');
        const devConsoleOutput = document.getElementById('dev-console-output');
        const copyLogBtn = document.getElementById('copy-log-btn');

        // --- DYNAMIC HTML INJECTION ---
        document.getElementById('preview-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2>PDF Preview</h2><span class="close-btn" id="preview-close-btn">&times;</span></div><div class="modal-body"><iframe id="pdf-preview-iframe" frameborder="0"></iframe></div><div class="modal-footer"><button id="download-btn">Download</button></div></div>`;
        document.getElementById('emphasis-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2 id="emphasis-modal-title">Highlight Inventory</h2><span class="close-btn" id="emphasis-close-btn">&times;</span></div><div class="modal-body"><div class="emphasis-header"><div class="emphasis-header-hide"></div><div class="emphasis-header-partial"><input type="checkbox" id="master-partial-checkbox" title="Select/Deselect All Partial"></div><div class="emphasis-header-full"><input type="checkbox" id="master-full-checkbox" title="Select/Deselect All Full"></div><div class="emphasis-header-text">(Highlight partial/full)</div></div><div id="emphasis-list-container"></div></div><div class="modal-footer"><button id="emphasis-done-btn">Done</button></div></div>`;
        document.getElementById('dev-mode-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2>Dev Mode</h2><span class="close-btn" id="dev-mode-close-btn">&times;</span></div><div class="modal-body"><div id="dev-mode-text"><p><strong>developer mode activated lol</strong></p><p>(this doesn't do anything)</p></div></div></div>`;
        
        // --- DYNAMIC UI ELEMENT SELECTORS (must be after injection) ---
        const previewModal = document.getElementById('preview-modal');
        const emphasisModal = document.getElementById('emphasis-modal');
        const devModeModal = document.getElementById('dev-mode-modal');
        const iframe = document.getElementById('pdf-preview-iframe');
        const previewCloseBtn = document.getElementById('preview-close-btn');
        const emphasisCloseBtn = document.getElementById('emphasis-close-btn');
        const emphasisDoneBtn = document.getElementById('emphasis-done-btn');
        const devModeCloseBtn = document.getElementById('dev-mode-close-btn');
        const downloadBtn = document.getElementById('download-btn');

        // --- CORE LOGIC FUNCTIONS ---
        const getTextFromPdf = (file) => { /* identical to v12 */ return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = async (event) => { try { const pdf = await pdfjsLib.getDocument({ data: event.target.result }).promise; let textContent = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const text = await page.getTextContent(); textContent += text.items.map(s => s.str).join(' '); } resolve(textContent); } catch (error) { reject(error); } }; reader.onerror = (error) => reject(error); reader.readAsArrayBuffer(file); }); };
        const parseInventoryText = (text) => { /* identical to v19 */ if (!text) return { preFilterList: [], postFilterList: [] }; const dataStartIndex = text.indexOf('Quantity'); if (dataStartIndex === -1) return { preFilterList: [], postFilterList: [] }; const dataText = text.substring(dataStartIndex + 'Quantity'.length); const inventoryRegex = /(.+?)\s+(\d+\s?GB)\s+([a-zA-Z\s]+?)\s+(\d+\s+available)/g; const matches = [...dataText.matchAll(inventoryRegex)]; const preFilterList = []; const postFilterList = []; const unlockedRegex = /un\s?-?\s?lock\s?-?\s?e\s?d/i; for (const match of matches) { const model = match[1].trim(); const capacity = match[2].trim(); const modelAndCapacity = `${model} ${capacity}`; const color = match[3].trim(); const quantity = match[4].match(/\d+/)[0]; const item = [modelAndCapacity, color, quantity]; preFilterList.push(item); if (!unlockedRegex.test(match[0])) { postFilterList.push(item); } } return { preFilterList, postFilterList }; };
        const abbreviateColor = (color) => { /* identical to v12 */ const c = color.toLowerCase(); if (c.includes('titanium') && c.includes('black')) return 'Black'; if (c.includes('space black')) return 'Black'; if (c.includes('sky blue') || c.includes('deep blue') || c.includes('ultramarine')) return 'Blue'; if (c.includes('titanium')) return c.split(' ')[0].charAt(0).toUpperCase() + c.split(' ')[0].slice(1); if (c.includes('orange')) return 'Orange'; return color.split(' ')[0].charAt(0).toUpperCase() + color.split(' ')[0].slice(1); };
        const consolidateInventory = (inventoryList) => { /* identical to v12 */ const consolidationMap = new Map(); for (const [modelAndCapacity, color, quantity] of inventoryList) { const key = modelAndCapacity; if (!consolidationMap.has(key)) { consolidationMap.set(key, { modelAndCapacity, details: [] }); } const abbreviated = abbreviateColor(color); consolidationMap.get(key).details.push({ color: abbreviated, quantity }); } const consolidatedList = []; for (const value of consolidationMap.values()) { const detailsString = value.details.map(d => `${d.quantity} ${d.color}`).join(', '); consolidatedList.push([value.modelAndCapacity, detailsString]); } return consolidatedList; };
        const categorizePdf = (text) => { /* identical to v12 */ const lowerCaseText = text.toLowerCase(); if (lowerCaseText.includes('at&t')) return 'att'; if (lowerCaseText.includes('verizon') || lowerCaseText.includes('vzw')) return 'vzw'; if (lowerCaseText.includes('t-mobile') || lowerCaseText.includes('tmo')) return 'tmo'; return 'unknown'; };
        const prepareDataForDisplay = () => { /* identical to v20 */ const preparedState = { att: {}, vzw: {}, tmo: {} }; if (isolateIphonesCheckbox.checked) { const priorityOrder = ['att', 'vzw', 'tmo']; let iphoneSource = null; for (const carrier of priorityOrder) { if (appState[carrier].consolidatedList.some(item => item[0].toLowerCase().startsWith('iphone'))) { iphoneSource = carrier; break; } } preparedState.apple = { consolidatedList: [] }; for (const carrier of ['att', 'vzw', 'tmo']) { preparedState[carrier].consolidatedList = appState[carrier].consolidatedList.filter(item => !item[0].toLowerCase().startsWith('iphone')); if (carrier === iphoneSource) { const iphones = appState[carrier].consolidatedList.filter(item => item[0].toLowerCase().startsWith('iphone')).map(item => ({ modelAndCapacity: item[0], details: item[1], sourceCarrier: carrier })); preparedState.apple.consolidatedList = iphones; } } } else { preparedState.att.consolidatedList = appState.att.consolidatedList; preparedState.vzw.consolidatedList = appState.vzw.consolidatedList; preparedState.tmo.consolidatedList = appState.tmo.consolidatedList; } return preparedState; };
        const generateFinalPdf = (state, comments) => { /* identical to v20 */ const { jsPDF } = window.jspdf; const doc = new jsPDF(); const topMargin = 12.7, sideMargin = 6.35, bottomMargin = 6.35; const pageHeight = 297, lineHeight = 4.5, sectionSpacing = 7; const headerHeight = 6, listTopMargin = 2; let yPosition = topMargin; const timestamp = new Date().toLocaleString(); const headerLines = [`${timestamp} - This inventory report was made using Spamfan's inventory optimizer ${APP_VERSION.slice(0, -1)}.)`, "This software is in development and can make mistakes."]; doc.setFont("helvetica", "normal").setFontSize(8).text(headerLines, sideMargin, yPosition); yPosition += (headerLines.length * lineHeight); if (comments) { const splitComments = doc.splitTextToSize(comments, 190); doc.setFont("helvetica", "italic").text(splitComments, sideMargin, yPosition); yPosition += (splitComments.length * (lineHeight - 1)); } yPosition += sectionSpacing; const contentStartY = yPosition; const calculateSectionHeight = (carrier, list) => { if (!list || list.length === 0) return 0; let visibleCount = 0; list.forEach(item => { const model = (carrier === 'apple') ? item.modelAndCapacity : item[0]; const source = (carrier === 'apple') ? item.sourceCarrier : carrier; const emphasis = appState[source].emphasis.get(model) || {}; if (!emphasis.hidden) { visibleCount++; } }); return headerHeight + listTopMargin + (visibleCount * lineHeight) + sectionSpacing; }; const carriersForLayout = Object.keys(state).filter(c => state[c].consolidatedList && state[c].consolidatedList.length > 0); const leftColumnCarriers = carriersForLayout.filter(c => c !== 'apple' && c !== 'tmo'); const rightColumnCarriers = carriersForLayout.filter(c => c === 'apple' || c === 'tmo'); let leftColumnHeight = 0; leftColumnCarriers.forEach(c => leftColumnHeight += calculateSectionHeight(c, state[c].consolidatedList)); let rightColumnHeight = 0; rightColumnCarriers.forEach(c => rightColumnHeight += calculateSectionHeight(c, state[c].consolidatedList)); const availablePageHeight = pageHeight - contentStartY - bottomMargin; const useTwoColumnLayout = (leftColumnHeight <= availablePageHeight) && (rightColumnHeight <= availablePageHeight) && (rightColumnHeight > 0); const drawSection = (carrier, data, currentX) => { doc.setFont("helvetica", "bold").setFontSize(10); const headerText = (carrier === 'apple') ? 'Apple Devices' : carrier.toUpperCase(); const headerWidth = doc.getTextWidth(headerText); doc.text(headerText, currentX, yPosition); doc.setLineWidth(0.2).line(currentX, yPosition + 0.5, currentX + headerWidth, yPosition + 0.5); yPosition += headerHeight; doc.setFontSize(8); const modelX = currentX; const detailsX = currentX + 55; data.consolidatedList.forEach(item => { const isApple = carrier === 'apple'; const modelAndCapacity = isApple ? item.modelAndCapacity : item[0]; const details = isApple ? item.details : item[1]; const sourceCarrier = isApple ? item.sourceCarrier : carrier; const emphasisState = (appState[sourceCarrier].emphasis.get(modelAndCapacity) || {}); if (emphasisState.hidden) return; doc.setFont('helvetica', 'normal'); if (emphasisState.full || emphasisState.partial) { doc.setFillColor(150, 150, 150); const textDimensions = doc.getTextDimensions(details, { fontSize: 8 }); const rectY = yPosition - textDimensions.h + 0.2; const rectHeight = textDimensions.h + 0.5; let rectWidth; if (emphasisState.full) { rectWidth = (detailsX - modelX) + textDimensions.w + 2; } else { const modelDimensions = doc.getTextDimensions(modelAndCapacity, { fontSize: 8 }); rectWidth = modelDimensions.w + 2; } doc.rect(modelX - 1, rectY, rectWidth, rectHeight, 'F'); } doc.text(modelAndCapacity, modelX, yPosition); doc.text(details, detailsX, yPosition); yPosition += lineHeight; }); yPosition += sectionSpacing; }; if (useTwoColumnLayout) { leftColumnCarriers.forEach(c => drawSection(c, state[c], sideMargin)); yPosition = contentStartY; rightColumnCarriers.forEach(c => drawSection(c, state[c], 110)); } else { carriersForLayout.forEach(carrier => { const sectionHeight = calculateSectionHeight(carrier, state[carrier].consolidatedList); if (yPosition + sectionHeight > (pageHeight - bottomMargin) && yPosition > contentStartY) { doc.addPage(); yPosition = topMargin; doc.setFont("helvetica", "normal").setFontSize(8).text(headerLines, sideMargin, yPosition); yPosition += (headerLines.length * lineHeight); if (comments) { const splitComments = doc.splitTextToSize(comments, 190); doc.setFont("helvetica", "italic").text(splitComments, sideMargin, yPosition); yPosition += (splitComments.length * (lineHeight-1)); } yPosition += sectionSpacing; } drawSection(carrier, state[carrier], sideMargin); }); } if (carriersForLayout.length === 0) { doc.setFont("helvetica", "normal").setFontSize(12).text("No inventory found.", sideMargin, yPosition); } return doc.output('datauristring'); };

        // --- EVENT HANDLER FUNCTIONS ---
        const handleFileUploads = async (files) => { /* identical to v18 */ if (!files || files.length === 0) return; uploadArea.querySelector('p').textContent = 'Processing...'; if (devConsoleToggle.checked) devConsoleOutput.textContent = ''; for (const file of files) { try { const text = await getTextFromPdf(file); const carrier = categorizePdf(text); if (carrier === 'unknown') { alert(`Could not determine carrier for file: ${file.name}`); continue; } const { preFilterList, postFilterList } = parseInventoryText(text); appState[carrier].consolidatedList = consolidateInventory(postFilterList); const statusSection = document.getElementById(`${carrier}-status`); statusSection.querySelector('.status-filename').textContent = file.name; statusSection.style.display = 'block'; if (devConsoleToggle.checked) { let logContent = `--- DEBUG LOG FOR: ${file.name} (detected as ${carrier.toUpperCase()}) ---\n\n`; logContent += `== RAW TEXT EXTRACTED ==\n${text}\n\n`; logContent += `== ITEMS FOUND (PRE-FILTER) ==\n${preFilterList.map(item => item.join(' | ')).join('\n')}\n\n`; logContent += `== ITEMS KEPT (POST-FILTER) ==\n${postFilterList.map(item => item.join(' | ')).join('\n')}\n\n`; devConsoleOutput.textContent += logContent; } } catch (error) { alert(`Failed to process file: ${file.name}`); console.error(error); } } uploadArea.querySelector('p').textContent = 'Drag & drop files here.'; };
        const openEmphasisModal = () => { /* identical to v17 */ const listContainer = document.getElementById('emphasis-list-container'); listContainer.innerHTML = ''; const processedData = prepareDataForDisplay(); const carriersToDisplay = Object.keys(processedData).filter(c => processedData[c].consolidatedList.length > 0); carriersToDisplay.forEach(carrier => { const header = document.createElement('div'); header.className = 'emphasis-list-carrier-header'; header.textContent = (carrier === 'apple') ? 'Apple Devices' : carrier.toUpperCase(); listContainer.appendChild(header); processedData[carrier].consolidatedList.forEach(item => { const isApple = carrier === 'apple'; const modelAndCapacity = isApple ? item.modelAndCapacity : item[0]; const details = isApple ? item.details : item[1]; const sourceCarrier = isApple ? item.sourceCarrier : carrier; const currentEmphasis = appState[sourceCarrier].emphasis.get(modelAndCapacity) || { partial: false, full: false, hidden: false }; const itemDiv = document.createElement('div'); itemDiv.className = 'emphasis-item'; if (currentEmphasis.hidden) itemDiv.classList.add('item-hidden'); const hideDiv = document.createElement('div'); hideDiv.className = 'emphasis-item-hide'; hideDiv.innerHTML = HIDE_ICON_SVG; hideDiv.dataset.key = modelAndCapacity; hideDiv.dataset.carrier = sourceCarrier; const partialCheckbox = document.createElement('input'); partialCheckbox.type = 'checkbox'; partialCheckbox.checked = currentEmphasis.partial; partialCheckbox.disabled = currentEmphasis.hidden; partialCheckbox.dataset.key = modelAndCapacity; partialCheckbox.dataset.carrier = sourceCarrier; partialCheckbox.dataset.type = 'partial'; const fullCheckbox = document.createElement('input'); fullCheckbox.type = 'checkbox'; fullCheckbox.checked = currentEmphasis.full; fullCheckbox.disabled = currentEmphasis.hidden; fullCheckbox.dataset.key = modelAndCapacity; fullCheckbox.dataset.carrier = sourceCarrier; fullCheckbox.dataset.type = 'full'; const textDiv = document.createElement('div'); textDiv.className = 'emphasis-item-text'; textDiv.textContent = `${modelAndCapacity} - ${details}`; itemDiv.appendChild(hideDiv); itemDiv.appendChild(partialCheckbox); itemDiv.appendChild(fullCheckbox); itemDiv.appendChild(textDiv); listContainer.appendChild(itemDiv); }); }); emphasisModal.style.display = 'flex'; };

        // --- ATTACH EVENT LISTENERS ---
        highlightBtn.addEventListener('click', openEmphasisModal);
        processBtn.addEventListener('click', () => { const processedData = prepareDataForDisplay(); const comments = commentsInput.value; const pdfDataUri = generateFinalPdf(processedData, comments); iframe.src = pdfDataUri; previewModal.style.display = 'flex'; });
        uploadArea.addEventListener('click', () => uploadInput.click());
        uploadInput.addEventListener('change', (e) => handleFileUploads(e.target.files));
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFileUploads(e.dataTransfer.files); });
        isolateIphonesCheckbox.addEventListener('change', saveSettings);
        devConsoleToggle.addEventListener('change', () => { 
            devConsoleContainer.style.display = devConsoleToggle.checked ? 'block' : 'none';
            downloadBtn.style.display = devConsoleToggle.checked ? 'inline-block' : 'none';
        });
        copyLogBtn.addEventListener('click', () => { /* identical to v19 */ const logText = devConsoleOutput.textContent; if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(logText).then(() => { alert('Log copied to clipboard!'); }).catch(err => { console.warn('Modern clipboard API failed, trying fallback.', err); legacyCopy(logText); }); } else { legacyCopy(logText); } });
        const legacyCopy = (text) => { /* identical to v20 */ const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.top = 0; textArea.style.left = 0; textArea.style.opacity = 0; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { const successful = document.execCommand('copy'); if (!successful) { alert('Failed to copy log.'); } } catch (err) { alert('Failed to copy log.'); } document.body.removeChild(textArea); };
        
        previewCloseBtn.addEventListener('click', () => previewModal.style.display = 'none');
        emphasisCloseBtn.addEventListener('click', () => emphasisModal.style.display = 'none');
        emphasisDoneBtn.addEventListener('click', () => emphasisModal.style.display = 'none');
        devModeCloseBtn.addEventListener('click', () => { if (devModalCloseable.button) devModeModal.style.display = 'none'; });
        window.addEventListener('click', (event) => { if (event.target == previewModal) previewModal.style.display = 'none'; if (event.target == emphasisModal) emphasisModal.style.display = 'none'; if (event.target == devModeModal && devModalCloseable.backdrop) devModeModal.style.display = 'none'; });
        downloadBtn.addEventListener('click', () => { const link = document.createElement('a'); link.href = iframe.src; link.download = 'Combined_Inventory.pdf'; link.click(); });
        
        emphasisModal.addEventListener('click', (e) => { /* identical to v16 */ const target = e.target.closest('.emphasis-item-hide'); if (!target) return; const { key, carrier } = target.dataset; const state = appState[carrier].emphasis.get(key) || { partial: false, full: false }; state.hidden = !state.hidden; appState[carrier].emphasis.set(key, state); const parentItem = target.closest('.emphasis-item'); parentItem.classList.toggle('item-hidden'); parentItem.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.disabled = state.hidden); saveSettings(); });
        emphasisModal.addEventListener('change', (e) => { /* identical to v16 */ const target = e.target; if (target.type !== 'checkbox') return; const isMaster = target.id.startsWith('master-'); if (isMaster) { const masterType = target.id.includes('partial') ? 'partial' : 'full'; const isChecking = target.checked; const allItems = emphasisModal.querySelectorAll('.emphasis-item:not(.item-hidden)'); allItems.forEach(item => { const partialBox = item.querySelector('[data-type="partial"]'); const fullBox = item.querySelector('[data-type="full"]'); const key = partialBox.dataset.key; const carrier = partialBox.dataset.carrier; const state = appState[carrier].emphasis.get(key) || { partial: false, full: false }; if (masterType === 'partial') { partialBox.checked = isChecking; state.partial = isChecking; if (!isChecking) { fullBox.checked = false; state.full = false; } } else { fullBox.checked = isChecking; state.full = isChecking; if (isChecking) { partialBox.checked = true; state.partial = true; } } appState[carrier].emphasis.set(key, state); }); const masterPartial = document.getElementById('master-partial-checkbox'); const masterFull = document.getElementById('master-full-checkbox'); if (masterType === 'full' && isChecking) masterPartial.checked = true; if (masterType === 'partial' && !isChecking) masterFull.checked = false; } else if (target.dataset.key) { const { key, carrier, type } = target.dataset; const state = appState[carrier].emphasis.get(key) || { partial: false, full: false }; state[type] = target.checked; const parentItem = target.closest('.emphasis-item'); if (parentItem) { const partialBox = parentItem.querySelector('[data-type="partial"]'); const fullBox = parentItem.querySelector('[data-type="full"]'); if (type === 'full' && target.checked) { state.partial = true; if (partialBox) partialBox.checked = true; } if (type === 'partial' && !target.checked) { state.full = false; if (fullBox) fullBox.checked = false; } } appState[carrier].emphasis.set(key, state); } saveSettings(); });
        
        let clickCount = 0, lastClick = 0;
        versionSpan.addEventListener('click', () => { /* identical to v16 */ const now = Date.now(); if (now - lastClick > 500) { clickCount = 0; } lastClick = now; clickCount++; if (clickCount === 7) { devModalCloseable.button = false; devModalCloseable.backdrop = false; devModeModal.style.display = 'flex'; setTimeout(() => { devModalCloseable.button = true; }, 500); setTimeout(() => { devModalCloseable.backdrop = true; }, 1000); clickCount = 0; } });
        commentsInput.addEventListener('input', (e) => { const konami = "upupdowndownleftrightleftrightba"; const input = e.target.value.toLowerCase().replace(/[^a-z0-9]/g, ''); konamiMessage.style.display = input.includes(konami) ? 'block' : 'none'; });

        // Initial load of settings from localStorage
        loadSettings();
    });
    </script>

</body>
</html>