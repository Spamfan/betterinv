<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>spamfan's better inventory v8</title>
    
    <!-- PDF.js and jsPDF library CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        #app-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        h1 {
            color: #1c1e21;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        
        #version-span {
            font-weight: normal;
        }

        #upload-area {
            border: 2px dashed #dddfe2;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        
        #upload-area.dragover {
            border-color: #1877f2;
            background-color: #f0f8ff;
        }
        
        #upload-area p {
            margin: 0;
            font-weight: 600;
            color: #606770;
        }
        
        #upload-input {
            display: none;
        }

        .status-section {
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: left;
        }
        
        .status-text { font-weight: 600; }
        .status-filename { font-weight: normal; font-style: italic; color: #606770; margin-left: 8px; }

        .emphasize-btn {
            padding: 8px 15px;
            border-radius: 6px;
            border: 1px solid #dddfe2;
            background-color: #f0f2f5;
            font-weight: 600;
            cursor: pointer;
        }

        #process-btn {
            background-color: #1877f2;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .control-section {
            text-align: left;
            margin-bottom: 15px;
        }
        
        .control-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #606770;
        }
        
        #comments {
            width: 100%;
            padding: 10px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            box-sizing: border-box;
            resize: vertical;
            min-height: 60px;
        }
        
        /* Modal Styles are identical to previous versions */
        .modal-container { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); width: 80%; max-width: 600px; max-height: 90%; display: flex; flex-direction: column; }
        .modal-header { padding: 10px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.2em; }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .emphasis-header { padding: 10px 20px; border-bottom: 1px solid #ddd; display: flex; font-weight: bold; font-size: 0.8em; color: #606770; background-color: #f0f2f5; }
        .emphasis-header-bold, .emphasis-header-box { min-width: 40px; text-align: center; }
        .emphasis-header-text { flex-grow: 1; padding-left: 5px; }
        .modal-body { flex-grow: 1; padding: 0; overflow-y: auto; }
        #emphasis-list-container { padding: 5px 20px; }
        #pdf-preview-iframe { width: 100%; height: 100%; border: none; }
        .emphasis-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #e9ebee; }
        .emphasis-item input[type="checkbox"] { min-width: 40px; height: 18px; margin: 0; }
        .emphasis-item-text { font-size: 0.9em; padding-left: 5px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; }
        .modal-footer button { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="app-container">
        <h1>Spamfan's better inventory <span id="version-span"></span></h1>
        
        <div id="upload-area">
            <input type="file" id="upload-input" multiple accept=".pdf">
            <p>Click to select PDFs, or drag & drop files here.</p>
        </div>

        <div id="status-container">
            <div class="status-section" id="att-status">
                <div><span class="status-text">AT&T:</span><span class="status-filename"></span></div>
                <button class="emphasize-btn" data-carrier="att">Emphasize</button>
            </div>
            <div class="status-section" id="vzw-status">
                <div><span class="status-text">Verizon:</span><span class="status-filename"></span></div>
                <button class="emphasize-btn" data-carrier="vzw">Emphasize</button>
            </div>
            <div class="status-section" id="tmo-status">
                <div><span class="status-text">T-Mobile:</span><span class="status-filename"></span></div>
                <button class="emphasize-btn" data-carrier="tmo">Emphasize</button>
            </div>
        </div>
        
        <button id="process-btn">Generate Combined PDF</button>

        <div class="control-section">
            <label for="comments">Comments (optional)</label>
            <textarea id="comments"></textarea>
        </div>
    </div>

    <!-- Modals are empty here, populated by script -->
    <div id="preview-modal" class="modal-container"></div>
    <div id="emphasis-modal" class="modal-container"></div>

    <script>
        document.getElementById('version-span').textContent = '(Alpha v8)';

        // Set workerSrc for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;

        // --- GLOBAL STATE ---
        const appState = {
            att: { consolidatedList: [], emphasis: new Map() },
            vzw: { consolidatedList: [], emphasis: new Map() },
            tmo: { consolidatedList: [], emphasis: new Map() }
        };

        // --- UI ELEMENT SELECTORS ---
        const uploadArea = document.getElementById('upload-area');
        const uploadInput = document.getElementById('upload-input');
        const processBtn = document.getElementById('process-btn');
        const commentsInput = document.getElementById('comments');

        // --- CORE LOGIC (identical to v7, just copied for a full file) ---
        const getTextFromPdf = (file) => { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = async (event) => { try { const pdf = await pdfjsLib.getDocument({ data: event.target.result }).promise; let textContent = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const text = await page.getTextContent(); textContent += text.items.map(s => s.str).join(' '); } resolve(textContent); } catch (error) { reject(error); } }; reader.onerror = (error) => reject(error); reader.readAsArrayBuffer(file); }); };
        const parseInventoryText = (text) => { if (!text) return []; const dataStartIndex = text.indexOf('Quantity'); if (dataStartIndex === -1) return []; const dataText = text.substring(dataStartIndex + 'Quantity'.length); const inventoryRegex = /(.+?)\s+(\d+\s?GB)\s+([a-zA-Z\s]+?)\s+(\d+\s+available)/g; const matches = [...dataText.matchAll(inventoryRegex)]; const inventory = []; const unlockedRegex = /unlock\s?ed/i; for (const match of matches) { if (!unlockedRegex.test(match[0])) { const model = match[1].trim(); const capacity = match[2].trim(); const modelAndCapacity = `${model} ${capacity}`; const color = match[3].trim(); const quantity = match[4].match(/\d+/)[0]; inventory.push([modelAndCapacity, color, quantity]); } } return inventory; };
        const abbreviateColor = (color) => { const c = color.toLowerCase(); if (c.includes('titanium') && c.includes('black')) return 'Black'; if (c.includes('space black')) return 'Black'; if (c.includes('sky blue') || c.includes('deep blue') || c.includes('ultramarine')) return 'Blue'; if (c.includes('titanium')) return c.split(' ')[0].charAt(0).toUpperCase() + c.split(' ')[0].slice(1); if (c.includes('orange')) return 'Orange'; return color.split(' ')[0].charAt(0).toUpperCase() + color.split(' ')[0].slice(1); };
        const consolidateInventory = (inventoryList) => { const consolidationMap = new Map(); for (const [modelAndCapacity, color, quantity] of inventoryList) { const key = modelAndCapacity; if (!consolidationMap.has(key)) { consolidationMap.set(key, { modelAndCapacity, details: [] }); } const abbreviated = abbreviateColor(color); consolidationMap.get(key).details.push({ color: abbreviated, quantity }); } const consolidatedList = []; for (const value of consolidationMap.values()) { const detailsString = value.details.map(d => `${d.quantity} ${d.color}`).join(', '); consolidatedList.push([value.modelAndCapacity, detailsString]); } return consolidatedList; };
        const categorizePdf = (text) => { const lowerCaseText = text.toLowerCase(); if (lowerCaseText.includes('at&t')) return 'att'; if (lowerCaseText.includes('verizon') || lowerCaseText.includes('vzw')) return 'vzw'; if (lowerCaseText.includes('t-mobile') || lowerCaseText.includes('tmo')) return 'tmo'; return 'unknown'; };

        const generateFinalPdf = (state, comments) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const topMargin = 12.7, sideMargin = 6.35, bottomMargin = 6.35;
            const pageHeight = 297, lineHeight = 4.5, sectionSpacing = 7;
            const headerHeight = 6, listTopMargin = 2;
            let yPosition = topMargin;

            // --- Draw Header ---
            const timestamp = new Date().toLocaleString();
            doc.setFont("helvetica", "normal").setFontSize(8).text(timestamp, sideMargin, yPosition);
            yPosition += lineHeight;

            if (comments) {
                doc.setFont("helvetica", "italic");
                const splitComments = doc.splitTextToSize(comments, 190);
                doc.text(splitComments, sideMargin, yPosition);
                yPosition += (splitComments.length * (lineHeight - 1));
            }
            yPosition += sectionSpacing;
            const contentStartY = yPosition;

            // --- Smart Layout Calculation ---
            const calculateSectionHeight = (list) => { if (!list || list.length === 0) return 0; return headerHeight + listTopMargin + (list.length * lineHeight) + sectionSpacing; };
            const leftColumnHeight = calculateSectionHeight(state.att.consolidatedList) + calculateSectionHeight(state.vzw.consolidatedList);
            const rightColumnHeight = calculateSectionHeight(state.tmo.consolidatedList);
            const availablePageHeight = pageHeight - contentStartY - bottomMargin;
            const useTwoColumnLayout = (leftColumnHeight <= availablePageHeight) && (rightColumnHeight <= availablePageHeight) && (rightColumnHeight > 0);
            
            // --- Draw Content ---
            const drawSection = (carrier, data, currentX) => { /* ... identical to v7 ... */ doc.setFont("helvetica", "bold").setFontSize(10); const headerText = carrier.toUpperCase(); const headerWidth = doc.getTextWidth(headerText); doc.text(headerText, currentX, yPosition); doc.setLineWidth(0.2).line(currentX, yPosition + 0.5, currentX + headerWidth, yPosition + 0.5); yPosition += headerHeight; doc.setFontSize(8); const modelX = currentX; const detailsX = currentX + 55; data.consolidatedList.forEach(item => { const [modelAndCapacity, details] = item; const itemKey = modelAndCapacity; const emphasisState = data.emphasis.get(itemKey) || { box: false, bold: false }; const fontStyle = emphasisState.bold ? 'bold' : 'normal'; doc.setFont('helvetica', fontStyle); const textDimensions = doc.getTextDimensions(details, { fontSize: 8, fontStyle: fontStyle }); if (emphasisState.box) { const boxWidth = (detailsX - modelX) + textDimensions.w + 1; const boxHeight = textDimensions.h; const boxY = yPosition - textDimensions.h + 0.4; doc.setDrawColor(0).rect(modelX - 1, boxY, boxWidth, boxHeight); } doc.text(modelAndCapacity, modelX, yPosition); doc.text(details, detailsX, yPosition); yPosition += lineHeight; }); yPosition += sectionSpacing; };
            const carriersWithData = ['att', 'vzw', 'tmo'].filter(c => state[c].consolidatedList.length > 0);

            if (useTwoColumnLayout) {
                drawSection('att', state.att, sideMargin);
                drawSection('vzw', state.vzw, sideMargin);
                yPosition = contentStartY;
                drawSection('tmo', state.tmo, 110);
            } else {
                carriersWithData.forEach(carrier => {
                    const sectionHeight = calculateSectionHeight(state[carrier].consolidatedList);
                    if (yPosition + sectionHeight > (pageHeight - bottomMargin)) {
                        doc.addPage();
                        yPosition = topMargin;
                        // Re-draw header on new page
                        doc.setFont("helvetica", "normal").setFontSize(8).text(timestamp, sideMargin, yPosition);
                        yPosition += lineHeight;
                        if (comments) { const splitComments = doc.splitTextToSize(comments, 190); doc.text(splitComments, sideMargin, yPosition); yPosition += (splitComments.length * (lineHeight-1)); }
                        yPosition += sectionSpacing;
                    }
                    drawSection(carrier, state[carrier], sideMargin);
                });
            }

            if (carriersWithData.length === 0) {
                doc.setFont("helvetica", "normal").setFontSize(12).text("No inventory found.", sideMargin, yPosition);
            }
            return doc.output('datauristring');
        };

        // --- DYNAMIC UI & EVENT HANDLERS ---
        document.getElementById('preview-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2>PDF Preview</h2><span class="close-btn" id="preview-close-btn">&times;</span></div><div class="modal-body"><iframe id="pdf-preview-iframe" frameborder="0"></iframe></div><div class="modal-footer"><button id="print-btn">Print</button><button id="download-btn">Download</button></div></div>`;
        document.getElementById('emphasis-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2 id="emphasis-modal-title">Emphasize Inventory</h2><span class="close-btn" id="emphasis-close-btn">&times;</span></div><div class="modal-body"><div class="emphasis-header"><div class="emphasis-header-bold">Bold</div><div class="emphasis-header-box">Box</div><div class="emphasis-header-text">Item</div></div><div id="emphasis-list-container"></div></div><div class="modal-footer"><button id="emphasis-done-btn">Done</button></div></div>`;
        const previewModal = document.getElementById('preview-modal'), emphasisModal = document.getElementById('emphasis-modal'), iframe = document.getElementById('pdf-preview-iframe');
        const openEmphasisModal = (carrier) => { /* ... identical to v7 ... */ document.getElementById('emphasis-modal-title').textContent = `Emphasize ${carrier.toUpperCase()} Inventory`; const listContainer = document.getElementById('emphasis-list-container'); listContainer.innerHTML = ''; const data = appState[carrier]; data.consolidatedList.forEach(item => { const [modelAndCapacity, details] = item; const itemKey = modelAndCapacity; const currentEmphasis = data.emphasis.get(itemKey) || { box: false, bold: false }; const itemDiv = document.createElement('div'); itemDiv.className = 'emphasis-item'; const boldCheckbox = document.createElement('input'); boldCheckbox.type = 'checkbox'; boldCheckbox.checked = currentEmphasis.bold; boldCheckbox.addEventListener('change', (e) => { const state = data.emphasis.get(itemKey) || { box: false, bold: false }; state.bold = e.target.checked; data.emphasis.set(itemKey, state); }); const boxCheckbox = document.createElement('input'); boxCheckbox.type = 'checkbox'; boxCheckbox.checked = currentEmphasis.box; boxCheckbox.addEventListener('change', (e) => { const state = data.emphasis.get(itemKey) || { box: false, bold: false }; state.box = e.target.checked; data.emphasis.set(itemKey, state); }); const textDiv = document.createElement('div'); textDiv.className = 'emphasis-item-text'; textDiv.textContent = `${modelAndCapacity} - ${details}`; itemDiv.appendChild(boldCheckbox); itemDiv.appendChild(boxCheckbox); itemDiv.appendChild(textDiv); listContainer.appendChild(itemDiv); }); emphasisModal.style.display = 'flex'; };
        const handleFileUploads = async (files) => { if (!files || files.length === 0) return; uploadArea.querySelector('p').textContent = 'Processing...'; for (const file of files) { try { const text = await getTextFromPdf(file); const carrier = categorizePdf(text); if (carrier === 'unknown') { alert(`Could not determine carrier for file: ${file.name}`); continue; } const parsedList = parseInventoryText(text); appState[carrier].consolidatedList = consolidateInventory(parsedList); appState[carrier].emphasis.clear(); const statusSection = document.getElementById(`${carrier}-status`); statusSection.querySelector('.status-filename').textContent = file.name; statusSection.style.display = 'flex'; } catch (error) { alert(`Failed to process file: ${file.name}`); console.error(error); } } uploadArea.querySelector('p').textContent = 'Click to select more, or drag & drop files here.'; };
        document.querySelectorAll('.emphasize-btn').forEach(btn => btn.addEventListener('click', (e) => openEmphasisModal(e.target.dataset.carrier)));
        processBtn.addEventListener('click', () => { const comments = commentsInput.value; const pdfDataUri = generateFinalPdf(appState, comments); iframe.src = pdfDataUri; previewModal.style.display = 'flex'; });
        uploadArea.addEventListener('click', () => uploadInput.click());
        uploadInput.addEventListener('change', (e) => handleFileUploads(e.target.files));
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFileUploads(e.dataTransfer.files); });
        document.getElementById('preview-close-btn').addEventListener('click', () => previewModal.style.display = 'none');
        document.getElementById('emphasis-close-btn').addEventListener('click', () => emphasisModal.style.display = 'none');
        document.getElementById('emphasis-done-btn').addEventListener('click', () => emphasisModal.style.display = 'none');
        window.addEventListener('click', (event) => { if (event.target == previewModal) previewModal.style.display = 'none'; if (event.target == emphasisModal) emphasisModal.style.display = 'none'; });
        document.getElementById('download-btn').addEventListener('click', () => { const link = document.createElement('a'); link.href = iframe.src; link.download = 'Combined_Inventory.pdf'; link.click(); });
        document.getElementById('print-btn').addEventListener('click', () => { if (iframe.src) { window.open(iframe.src); } });

    </script>

</body>
</html>